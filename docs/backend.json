{
  "entities": {
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user of the application.",
      "properties": {
        "uid": {
          "type": "string",
          "description": "Unique identifier for the user (Firebase UID)."
        },
        "name": {
          "type": "string",
          "description": "The user's full name."
        },
        "email": {
          "type": "string",
          "description": "The user's email address.",
          "format": "email"
        },
        "role": {
          "type": "string",
          "description": "The user's role (user, ti, or admin).",
          "format": "string"
        },
        "status": {
          "type": "string",
          "description": "The user's status (active or suspended).",
          "enum": [
            "active",
            "suspended"
          ]
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp of when the user was created.",
          "format": "date-time"
        },
        "avatarUrl": {
          "type": "string",
          "description": "URL of the user's avatar image.",
          "format": "uri"
        }
      },
      "required": [
        "uid",
        "name",
        "email",
        "role",
        "createdAt",
        "status"
      ]
    },
    "Ticket": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Ticket",
      "type": "object",
      "description": "Represents a support ticket.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the ticket."
        },
        "ticketNumber": {
          "type": "number",
          "description": "A sequential number for the ticket."
        },
        "title": {
          "type": "string",
          "description": "The title of the ticket."
        },
        "description": {
          "type": "string",
          "description": "A detailed description of the issue."
        },
        "status": {
          "type": "string",
          "description": "The current status of the ticket (open, in_progress, resolved)."
        },
        "priority": {
          "type": "string",
          "description": "The priority of the ticket (low, normal, high)."
        },
        "userId": {
          "type": "string",
          "description": "Reference to User. The user who created the ticket. (Relationship: User 1:N Ticket)"
        },
        "assignedTo": {
          "type": "string",
          "description": "Reference to User. The user assigned to the ticket, if any. (Relationship: User 1:N Ticket)"
        },
        "assignedUserName": {
          "type": "string",
          "description": "Denormalized name of the user the ticket is assigned to."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp of when the ticket was created.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "ticketNumber",
        "title",
        "description",
        "status",
        "priority",
        "userId",
        "createdAt"
      ]
    },
    "Comment": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Comment",
      "type": "object",
      "description": "Represents a comment on a ticket.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the comment."
        },
        "ticketId": {
          "type": "string",
          "description": "Reference to Ticket. The ticket the comment belongs to. (Relationship: Ticket 1:N Comment)"
        },
        "userId": {
          "type": "string",
          "description": "Reference to User. The user who created the comment. (Relationship: User 1:N Comment)"
        },
        "message": {
          "type": "string",
          "description": "The content of the comment."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp of when the comment was created.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "ticketId",
        "userId",
        "message",
        "createdAt"
      ]
    },
    "Rating": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Rating",
      "type": "object",
      "description": "Represents a rating for a ticket.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the rating."
        },
        "ticketId": {
          "type": "string",
          "description": "Reference to Ticket. The ticket being rated. (Relationship: Ticket 1:N Rating)"
        },
        "rating": {
          "type": "number",
          "description": "The rating given (1 to 5).",
          "format": "number"
        },
        "comment": {
          "type": "string",
          "description": "Optional comment associated with the rating."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp of when the rating was created.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "ticketId",
        "rating",
        "createdAt"
      ]
    },
    "Counter": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Counter",
      "type": "object",
      "description": "A generic counter for generating sequential IDs.",
      "properties": {
        "lastNumber": {
          "type": "number",
          "description": "The last number that was used."
        }
      },
      "required": [
        "lastNumber"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Stores user profiles. The 'userId' parameter is the Firebase Authentication UID. The document includes the user's role (user, ti, admin).",
          "params": [
            {
              "name": "userId",
              "description": "The Firebase Authentication UID of the user."
            }
          ]
        }
      },
      {
        "path": "/tickets/{ticketId}",
        "definition": {
          "entityName": "Ticket",
          "schema": {
            "$ref": "#/backend/entities/Ticket"
          },
          "description": "Stores all support tickets in a top-level collection to allow for easier querying by support staff and admins. Each ticket contains a `userId` field to link it to its creator.",
          "params": [
            {
              "name": "ticketId",
              "description": "The unique identifier of the ticket."
            }
          ]
        }
      },
      {
        "path": "/tickets/{ticketId}/comments/{commentId}",
        "definition": {
          "entityName": "Comment",
          "schema": {
            "$ref": "#/backend/entities/Comment"
          },
          "description": "Stores comments associated with a ticket.",
          "params": [
            {
              "name": "ticketId",
              "description": "The unique identifier of the ticket."
            },
            {
              "name": "commentId",
              "description": "The unique identifier of the comment."
            }
          ]
        }
      },
      {
        "path": "/tickets/{ticketId}/ratings/{ratingId}",
        "definition": {
          "entityName": "Rating",
          "schema": {
            "$ref": "#/backend/entities/Rating"
          },
          "description": "Stores ratings associated with a ticket.",
          "params": [
            {
              "name": "ticketId",
              "description": "The unique identifier of the ticket."
            },
            {
              "name": "ratingId",
              "description": "The unique identifier of the rating."
            }
          ]
        }
      },
      {
        "path": "/counters/{counterId}",
        "definition": {
          "entityName": "Counter",
          "schema": {
            "$ref": "#/backend/entities/Counter"
          },
          "description": "Stores global counters for things like ticket numbers. The 'counterId' would be 'tickets', for example.",
          "params": [
            {
              "name": "counterId",
              "description": "The name of the counter (e.g., 'tickets')."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore structure is designed to support a ticket management system with user roles (user, ti, admin). It has been refactored to use a top-level `tickets` collection to allow `ti` and `admin` users to query all tickets, which is a common requirement for support dashboards and not efficiently supported by collection group queries under the previous model due to security rule limitations.\n\n**Authorization Independence:**\n\n*   **Users:** User roles are stored directly within the user document (`/users/{userId}`). This remains the single source of truth for a user's role and status.\n*   **Tickets:** Tickets are in a top-level collection. Each ticket contains a `userId` field to denote ownership. This allows security rules to grant access based on whether the requester's UID matches the `userId` field (ownership) or if the requester has an elevated role (`ti`, `admin`).\n*   **Comments & Ratings:** These are stored in subcollections under each ticket (`/tickets/{ticketId}/...`). Their security rules rely on fetching the parent ticket document to check its `userId` field, ensuring only the ticket owner or support staff can interact with them. This `get()` call is efficient and secure as it's scoped to a single document within the same collection path hierarchy.\n\n**QAPs Support:**\n\n*   Secure `list` operations are now fully supported. `ti` and `admin` roles can list the entire `/tickets` collection. Regular users cannot list the entire collection but can perform a secure, targeted query (`where('userId', '==', auth.uid)`) which is protected by `get` rules that enforce ownership on each document read.\n\n**Justification of Paths:**\n\n*   `/users/{userId}`: Stores user information, including their role and status. Essential for RBAC.\n*   `/tickets/{ticketId}`: A top-level collection for all tickets. This is the key change that enables efficient querying for support staff and admins. The `userId` field within each ticket document maintains the ownership link.\n*   `/tickets/{ticketId}/comments/{commentId}`: Comments are stored as a subcollection of tickets. This provides a clear hierarchy and allows for easy retrieval of comments associated with a specific ticket.\n*   `/tickets/{ticketId}/ratings/{ratingId}`: Ratings are stored as a subcollection of tickets, similar to comments."
  }
}
